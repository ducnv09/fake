analysis_task:
  description: >
    You are conducting a requirements gathering session with a user who wants to build software.

    Current conversation context:
    {conversation_context}

    User's latest message:
    {user_message}

    Current turn: {turn_count}
    Total requirements collected: {total_requirements}

    Your job is to:
    1. Extract ALL requirements from the user's message
    2. Return them in a structured format (see expected_output)
    3. Provide a conversational response

    Analyze the user's message and identify requirements in these categories:
    - Problem & Goals: What problem are they solving? What are the business objectives?
    - Users & Stakeholders: Who will use this? What are their roles and needs?
    - Features & Scope: What features do they need? What's in/out of scope?

    If the user's message contains NO new requirements (e.g., just "ok", "yes", "that's enough"),
    return an empty requirements section.

    Response rules:
    - CRITICAL: If turn >= 2 OR total_requirements >= 8, DO NOT ask any questions. Just thank them and summarize.
    - Otherwise: You may ask 1-2 clarifying questions

    IMPORTANT: Always respond in the SAME LANGUAGE as the user.
  expected_output: >
    You MUST return your response in this EXACT format:

    === EXTRACTED REQUIREMENTS ===
    PROBLEM_GOALS:
    - [requirement text]
    - [requirement text]

    USERS_STAKEHOLDERS:
    - [requirement text]
    - [requirement text]

    FEATURES_SCOPE:
    - [requirement text]
    - [requirement text]
    === END REQUIREMENTS ===

    === USER RESPONSE ===
    [Your conversational response here - acknowledge what they shared, confirm understanding, ask follow-up questions if needed]
    === END RESPONSE ===

    Example:
    === EXTRACTED REQUIREMENTS ===
    PROBLEM_GOALS:
    - Build an e-commerce platform to overcome offline sales limitations
    - Expand business reach through online book sales

    USERS_STAKEHOLDERS:
    - Students who need textbooks
    - Working professionals interested in books
    - Warehouse managers who need to manage inventory

    FEATURES_SCOPE:
    - Shopping cart functionality
    - QR code payment integration
    - Order management system
    === END REQUIREMENTS ===

    === USER RESPONSE ===
    Cảm ơn bạn đã chia sẻ thông tin chi tiết! Tôi hiểu bạn muốn xây dựng website bán sách với thanh toán QR code và quản lý kho hàng. Cho tôi hỏi thêm về...
    === END RESPONSE ===

    CRITICAL: Always include the === EXTRACTED REQUIREMENTS === section even if empty. Always include the === USER RESPONSE === section.
  agent: business_analyst

phase_evaluation_task:
  description: >
    Evaluate if the Analysis phase has collected sufficient requirements to proceed to the Solution phase.

    CRITICAL: You MUST use the State Manager Tool to check actual requirements. DO NOT rely on the summary text below.

    STEP 1 - CHECK COMPLETENESS (MANDATORY):
    You MUST call the State Manager Tool:
    Tool: State Manager Tool
    Parameters:
      - action: 'check_complete'

    This will return the ACTUAL count of requirements in each category.

    STEP 2 - ANALYZE THE TOOL RESULT:
    Based on the tool's response, evaluate:
    - Do we have at least 2 requirements in each category (problem_goals, users_stakeholders, features_scope)?
    - OR do we have at least 8 total requirements across all categories?
    - Are the requirements specific and actionable?

    STEP 3 - MAKE DECISION:
    - If criteria met: DECISION: READY
    - If criteria NOT met: DECISION: NOT_READY

    IMPORTANT: Base your decision ONLY on the tool result, NOT on the text summary below.

    Current requirements summary (for reference only):
    {requirements_summary}
  expected_output: >
    A clear decision in this format:

    DECISION: [READY or NOT_READY]

    REASONING: [2-3 sentences explaining why, citing ACTUAL numbers from the tool]

    NEXT_STEPS: [What should happen next - either move to Solution phase or what questions still need answers]
  agent: phase_coordinator

# ==================== SOLUTION DESIGN PHASE - BROKEN INTO 3 SEQUENTIAL TASKS ====================

solution_design_screens_task:
  description: >
    TASK 1/3: Design all user-facing SCREENS/PAGES for the solution.

    CRITICAL: You are a BUSINESS ANALYST, NOT a technical architect.
    Focus on WHAT the solution does for users, NOT HOW it's technically implemented.

    Product Brief (defines WHAT to build):
    {product_brief}

    Requirements to analyze:
    {requirements_summary}

    YOUR JOB: Analyze the Product Brief and identify ALL screens needed.

    STEP 1 - ANALYZE AND PLAN:
    Review the Product Brief and Requirements to identify ALL screens needed:
    - What screens do CUSTOMERS need? (e.g., browse products, view details, checkout, track orders)
    - What screens do ADMINS need? (e.g., manage inventory, view reports, manage orders)
    - What screens do EMPLOYEES need? (e.g., add products, update stock)

    STEP 2 - DESIGN SCREENS:
    For each screen, define:
    - name: Screen name (e.g., "Home Page", "Admin Dashboard")
    - purpose: What this screen does from business perspective
    - user_can: Array of actions users can perform
    - navigation: Object with "from" and "to" arrays showing navigation paths

    CRITICAL RULES:
    - Design ALL screens at once
    - DO NOT include technical details (React, Vue, Redux, etc.)
    - Focus on USER PERSPECTIVE: What can users DO on this screen?
    - Your output will be automatically parsed as ScreensOutput Pydantic model
  expected_output: >
    A complete list of all screens in the solution. Each screen must have:
    - name: Screen name
    - purpose: Business purpose
    - user_can: List of user actions
    - navigation: Navigation paths (from/to)
  agent: solution_designer

solution_design_services_task:
  description: >
    TASK 2/3: Design all BACKEND SERVICES for the solution.

    CRITICAL: You are a BUSINESS ANALYST, NOT a technical architect.

    Product Brief (defines WHAT to build):
    {product_brief}

    Requirements to analyze:
    {requirements_summary}

    Screens already designed:
    {solution_summary}

    YOUR JOB: Analyze the Product Brief and screens, identify ALL backend services needed.

    STEP 1 - ANALYZE AND PLAN:
    Review the Product Brief, Requirements, and Screens to identify ALL backend services needed:
    - What business functions need to be handled? (e.g., manage products, process orders, handle payments)
    - What data needs to be managed? (e.g., user data, inventory, orders)
    - What services support the screens you designed?

    STEP 2 - DESIGN SERVICES:
    For each service, define:
    - name: Service name (e.g., "Product Management Service")
    - purpose: What this service does from business perspective
    - responsibilities: Array of business responsibilities
    - supports_screens: Array of screen names this service supports

    CRITICAL RULES:
    - Design ALL services at once
    - DO NOT include technical details (API endpoints, database schemas, REST/GraphQL, SQL/NoSQL)
    - Focus on BUSINESS RESPONSIBILITIES: What business functions does this service handle?
    - Your output will be automatically parsed as ServicesOutput Pydantic model
  expected_output: >
    A complete list of all backend services in the solution. Each service must have:
    - name: Service name
    - purpose: Business purpose
    - responsibilities: List of business responsibilities
    - supports_screens: List of screen names
  agent: solution_designer

solution_design_flows_task:
  description: >
    TASK 3/3: Design all BUSINESS FLOWS (user journeys) for the solution.

    CRITICAL: You are a BUSINESS ANALYST, NOT a technical architect.

    Product Brief (defines WHAT to build):
    {product_brief}

    Requirements to analyze:
    {requirements_summary}

    Solution components already designed:
    {solution_summary}

    YOUR JOB: Analyze the Product Brief and identify ALL major user journeys/workflows.

    STEP 1 - ANALYZE AND PLAN:
    Review the Product Brief and solution components to identify ALL major flows needed:
    - What are the main user journeys? (e.g., customer purchasing a book, admin managing inventory)
    - What are the key workflows that achieve product goals?
    - What processes involve multiple screens and services?

    STEP 2 - DESIGN FLOWS:
    For each flow, define:
    - name: Flow name (e.g., "Book Purchase Flow")
    - description: What this flow accomplishes
    - steps: Array of detailed steps from start to finish
    - actors: Array of actors involved (users, systems, external services)

    CRITICAL RULES:
    - Design ALL flows at once
    - Focus on complete end-to-end user journeys
    - Include all steps from start to finish
    - Identify all actors (users, systems, external services)
    - Your output will be automatically parsed as FlowsOutput Pydantic model
  expected_output: >
    A complete list of all business flows in the solution. Each flow must have:
    - name: Flow name
    - description: What this flow accomplishes
    - steps: List of detailed steps
    - actors: List of actors involved
  agent: solution_designer

solution_validation_task:
  description: >
    Validate the designed solution for completeness and coherence against the Product Brief.

    STEP 1 - GET SOLUTION:
    Use the Solution Manager Tool to get current solution:
    Tool: Solution Manager Tool
    Parameters:
      - action: 'get_solution'

    STEP 2 - CHECK COMPLETENESS:
    Use the Solution Manager Tool to check if solution is complete:
    Tool: Solution Manager Tool
    Parameters:
      - action: 'check_complete'

    Product Brief (what we're building):
    {product_brief}

    Requirements to validate against:
    {requirements_summary}

    Current solution components:
    {solution_summary}

    STEP 3 - ANALYZE:
    - Does the solution support all Product Goals defined in the Brief?
    - Does every requirement have corresponding solution components?
    - Are all Target Users from the Brief considered in the solution?
    - Does the solution stay within the defined Scope from the Brief?
    - Are all user-facing features covered by screens/pages?
    - Are all business logic needs covered by backend services?
    - Are major user journeys documented as business flows?
    - Are there any gaps or missing pieces?

    STEP 4 - PROVIDE VALIDATION REPORT:
    Based on your analysis, provide the final validation report (do NOT make more tool calls after this).

    If gaps found: Clearly identify what's missing and recommend additions.
    If complete: Confirm solution is ready for backlog creation.
  expected_output: >
    A validation report in this EXACT format:

    VALIDATION STATUS: [COMPLETE or INCOMPLETE]

    COVERAGE ANALYSIS:
    - Screens: [Assessment of screens/pages coverage - do they cover all user-facing features?]
    - Services: [Assessment of backend services coverage - do they support all business logic?]
    - Flows: [Assessment of business flows coverage - are all user journeys documented?]

    GAPS IDENTIFIED: [List any missing components or flows, or "None" if complete]

    RECOMMENDATION: [What should happen next]

    CRITICAL: After providing this report, your task is COMPLETE. Do NOT make additional tool calls.
  agent: solution_validator

solution_phase_evaluation_task:
  description: >
    Evaluate if the Solution phase is complete and ready to move to Documentation phase.

    Use the Solution Manager Tool to:
    1. Get solution summary: action='get_summary'
    2. Check completeness: action='check_complete'

    Current solution status:
    {solution_summary}

    Validation results:
    {validation_results}

    Decision criteria:
    - At least 3 screens/pages defined
    - At least 2 backend services defined
    - At least 2 business flows documented
    - OR at least 7 total solution elements
    - All major requirements have corresponding solution components

    If ready: Recommend moving to Documentation phase.
    If not ready: Identify what still needs to be designed.
  expected_output: >
    A clear decision in this format:

    DECISION: [READY or NOT_READY]

    REASONING: [2-3 sentences explaining why]

    NEXT_STEPS: [What should happen next - either move to Documentation phase or what needs to be added to solution]
  agent: phase_coordinator

product_brief_creation_task:
  description: >
    Create a comprehensive Product Brief based on requirements analysis.
    This brief defines WHAT needs to be built, and will guide the Solution Design phase (HOW to build it).

    Requirements:
    {requirements_summary}

    Revision Feedback (if any):
    {revision_feedback}

    YOUR JOB: Analyze requirements and create a Product Brief with all required sections.

    STEP 1 - ANALYZE REQUIREMENTS:
    Review the requirements gathered during the analysis phase.
    Extract key information needed for each Product Brief section:
    - What problem are we solving? (from problem_goals)
    - Who are the users and what do they need? (from users_stakeholders)
    - What features should be included? (from features_scope)
    - What are the success criteria and objectives?

    STEP 2 - CREATE PRODUCT BRIEF:
    Design the Product Brief with these sections:
    - product_summary: Brief overview (2-3 sentences). Use clear, concise language.
    - problem_statement: What problem does this solve? Why is it needed? Write in short paragraphs (max 3-4 sentences each) separated by newlines.
    - target_users: Who will use this product? Format as numbered list, one user group per line.
    - product_goals: Key objectives and success criteria. Format as numbered list with clear goals.
    - scope: What's IN SCOPE and what's OUT OF SCOPE. Separate sections clearly.
    - revision_count: Set to 0 (or increment if revision_feedback provided)

    FORMATTING REQUIREMENTS:
    - Use \n for line breaks within each field to improve readability
    - Use numbered lists (1., 2., 3.) or bullet points (-, •) where appropriate
    - Keep paragraphs short (max 3-4 sentences before a line break)
    - Separate major sections within a field with double line breaks (\n\n)
    - Target Users: Format as numbered list, one user group per line
    - Product Goals: Format as numbered list with clear, measurable goals
    - Scope: Clearly separate IN SCOPE and OUT OF SCOPE sections

    If revision_feedback is provided, focus on addressing the specific feedback while keeping other sections intact.

    IMPORTANT: ALL fields are REQUIRED and must be filled with meaningful content based on requirements.
    Do NOT leave any field empty or with placeholder text.
  expected_output: >
    A complete Product Brief with all required sections filled with meaningful content from the requirements.
    The output will be automatically parsed as ProductBriefData Pydantic model.
  agent: product_brief_writer

product_brief_review_task:
  description: >
    Review the Product Brief for quality, clarity, and alignment with requirements.
    This brief will guide the Solution Design phase, so it must be complete and clear.

    STEP 1 - GET BRIEF:
    Use the Documentation Manager Tool to get the current brief:
    Tool: Documentation Manager Tool
    Parameters:
      - action: 'get_brief'

    Requirements:
    {requirements_summary}

    STEP 2 - EVALUATE:
    - Is the Product Summary clear and concise?
    - Does the Problem Statement accurately reflect the requirements?
    - Are Target Users well-defined based on stakeholder requirements?
    - Are Product Goals specific and measurable?
    - Is the Scope clear about what's included and excluded?
    - Does everything align with the requirements and solution?

    STEP 3 - PROVIDE REVIEW:
    Based on your evaluation, provide the final review report (do NOT make more tool calls after this).
    Provide specific, actionable feedback for improvements.
  expected_output: >
    A review report in this EXACT format:

    REVIEW STATUS: [APPROVED or NEEDS_REVISION]

    STRENGTHS: [What's good about the brief]

    IMPROVEMENT AREAS: [Specific sections that need work, if any]

    RECOMMENDATIONS: [Concrete suggestions for improvement]

    CRITICAL: After providing this review, your task is COMPLETE. Do NOT make additional tool calls.
  agent: brief_reviewer

epic_story_creation_task:
  description: >
    Create Epics and User Stories based on the Product Brief and Solution Design, organized by feature domain.

    Product Brief:
    {product_brief}

    Solution Design:
    {solution_summary}

    Revision Feedback (if any):
    {revision_feedback}

    YOUR JOB: Design comprehensive Epics and User Stories that cover all solution components.

    STEP 1 - UNDERSTAND PRODUCT CONTEXT:
    Review the Product Brief to understand:
    - Problem Statement: What problem are we solving?
    - Target Users: Who will use this system and what are their needs?
    - Product Goals: What are the success criteria?
    - Scope: What's in-scope vs out-of-scope?

    STEP 2 - IDENTIFY FEATURE DOMAINS:
    Based on solution components and product goals, identify 3-5 major feature domains (e.g., Product Management, Cart, Order, Payment, User Management).

    STEP 3 - DESIGN EPICS:
    For EACH feature domain, create an Epic with:
    - id: Epic ID (e.g., "epic-1", "epic-2")
    - name: Epic name
    - description: What this epic delivers
    - domain: Feature domain name

    STEP 4 - DESIGN USER STORIES:
    For EACH frontend component, backend API, and business flow, create 2-3 User Stories.
    IMPORTANT: Consider Target Users from Product Brief when writing stories (use correct roles like "customer", "admin", "warehouse manager").

    Each story must have:
    - epic_id: ID of the epic this story belongs to
    - title: In format "As a [role from Target Users], I want [feature] so that [benefit aligned with Product Goals]"
    - description: Detailed description of the story
    - acceptance_criteria: List of criteria in Given-When-Then format

    Target: Create at least 10-15 user stories total covering all solution components.
    Ensure stories align with Product Goals and stay within defined Scope.

    If revision_feedback is provided, focus on addressing specific gaps or changes requested.

    IMPORTANT: Create comprehensive epics and stories covering ALL solution components.
  expected_output: >
    A complete backlog with both epics and stories.
    Output format:
    - epics: List of all epics organized by feature domain
    - stories: List of all user stories with acceptance criteria

    The output will be automatically parsed as BacklogOutput Pydantic model.
  agent: epic_story_writer

backlog_validation_task:
  description: >
    Validate that Epics and Stories comprehensively cover the Product Brief scope and solution design.

    STEP 1 - GET DOCUMENTATION:
    Use the Documentation Manager Tool to get current documentation:
    Tool: Documentation Manager Tool
    Parameters:
      - action: 'get_documentation'

    Product Brief:
    {product_brief}

    Solution Design:
    {solution_summary}

    STEP 2 - ANALYZE COVERAGE:
    - Does every solution component (frontend/backend/flow) have corresponding user stories?
    - Are epics properly organized by feature domain?
    - Do all stories align with Target Users defined in Product Brief?
    - Do stories support Product Goals?
    - Are all in-scope features from Product Brief covered?
    - Are there any out-of-scope features included by mistake?
    - Do all stories have clear acceptance criteria?
    - Are there any gaps or missing stories?

    STEP 3 - PROVIDE VALIDATION:
    Based on your analysis, provide the final validation report (do NOT make more tool calls after this).
  expected_output: >
    A validation report in this EXACT format:

    VALIDATION STATUS: [COMPLETE or INCOMPLETE]

    COVERAGE ANALYSIS:
    - Epics: [Assessment of epic organization]
    - Stories: [Assessment of story coverage]
    - Acceptance Criteria: [Assessment of criteria quality]

    GAPS IDENTIFIED: [List any missing stories or epics, or "None" if complete]

    RECOMMENDATIONS: [What should be added or improved]

    CRITICAL: After providing this validation, your task is COMPLETE. Do NOT make additional tool calls.
  agent: backlog_validator
