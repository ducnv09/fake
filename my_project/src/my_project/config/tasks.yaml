analysis_task:
  description: >
    You are conducting a requirements gathering session with a user who wants to build software.

    Current conversation context:
    {conversation_context}

    User's latest message:
    {user_message}

    Current turn: {turn_count}
    Total requirements collected: {total_requirements}

    Your job is to:
    1. Extract ALL requirements from the user's message
    2. Return them in a structured format (see expected_output)
    3. Provide a conversational response

    Analyze the user's message and identify requirements in these categories:
    - Problem & Goals: What problem are they solving? What are the business objectives?
    - Users & Stakeholders: Who will use this? What are their roles and needs?
    - Features & Scope: What features do they need? What's in/out of scope?

    If the user's message contains NO new requirements (e.g., just "ok", "yes", "that's enough"),
    return an empty requirements section.

    Response rules:
    - CRITICAL: If turn >= 2 OR total_requirements >= 8, DO NOT ask any questions. Just thank them and summarize.
    - Otherwise: You may ask 1-2 clarifying questions

    IMPORTANT: Always respond in the SAME LANGUAGE as the user.
  expected_output: >
    You MUST return your response in this EXACT format:

    === EXTRACTED REQUIREMENTS ===
    PROBLEM_GOALS:
    - [requirement text]
    - [requirement text]

    USERS_STAKEHOLDERS:
    - [requirement text]
    - [requirement text]

    FEATURES_SCOPE:
    - [requirement text]
    - [requirement text]
    === END REQUIREMENTS ===

    === USER RESPONSE ===
    [Your conversational response here - acknowledge what they shared, confirm understanding, ask follow-up questions if needed]
    === END RESPONSE ===

    Example:
    === EXTRACTED REQUIREMENTS ===
    PROBLEM_GOALS:
    - Build an e-commerce platform to overcome offline sales limitations
    - Expand business reach through online book sales

    USERS_STAKEHOLDERS:
    - Students who need textbooks
    - Working professionals interested in books
    - Warehouse managers who need to manage inventory

    FEATURES_SCOPE:
    - Shopping cart functionality
    - QR code payment integration
    - Order management system
    === END REQUIREMENTS ===

    === USER RESPONSE ===
    Cảm ơn bạn đã chia sẻ thông tin chi tiết! Tôi hiểu bạn muốn xây dựng website bán sách với thanh toán QR code và quản lý kho hàng. Cho tôi hỏi thêm về...
    === END RESPONSE ===

    CRITICAL: Always include the === EXTRACTED REQUIREMENTS === section even if empty. Always include the === USER RESPONSE === section.
  agent: business_analyst

phase_evaluation_task:
  description: >
    Evaluate if the Analysis phase has collected sufficient requirements to proceed to the Solution phase.

    CRITICAL: You MUST use the State Manager Tool to check actual requirements. DO NOT rely on the summary text below.

    STEP 1 - CHECK COMPLETENESS (MANDATORY):
    You MUST call the State Manager Tool:
    Tool: State Manager Tool
    Parameters:
      - action: 'check_complete'

    This will return the ACTUAL count of requirements in each category.

    STEP 2 - ANALYZE THE TOOL RESULT:
    Based on the tool's response, evaluate:
    - Do we have at least 2 requirements in each category (problem_goals, users_stakeholders, features_scope)?
    - OR do we have at least 8 total requirements across all categories?
    - Are the requirements specific and actionable?

    STEP 3 - MAKE DECISION:
    - If criteria met: DECISION: READY
    - If criteria NOT met: DECISION: NOT_READY

    IMPORTANT: Base your decision ONLY on the tool result, NOT on the text summary below.

    Current requirements summary (for reference only):
    {requirements_summary}
  expected_output: >
    A clear decision in this format:

    DECISION: [READY or NOT_READY]

    REASONING: [2-3 sentences explaining why, citing ACTUAL numbers from the tool]

    NEXT_STEPS: [What should happen next - either move to Solution phase or what questions still need answers]
  agent: phase_coordinator

solution_design_task:
  description: >
    Design a comprehensive BUSINESS solution based on the collected requirements.

    CRITICAL: You are a BUSINESS ANALYST, NOT a technical architect.
    Focus on WHAT the solution does for users, NOT HOW it's technically implemented.

    Requirements to analyze:
    {requirements_summary}

    CRITICAL: You MUST follow these steps IN ORDER:

    STEP 1 - ANALYZE REQUIREMENTS:
    Review all requirements and understand:
    - What problem needs to be solved
    - Who will use the system and what they need
    - What features and capabilities are needed

    STEP 2 - DESIGN SCREENS/PAGES (MANDATORY):
    For EACH user-facing screen needed, you MUST call the Solution Manager Tool:
    Tool: Solution Manager Tool
    Parameters:
      - action: 'add_screen'
      - component_data: JSON string with structure:
        {
          "name": "Screen Name (e.g., Home Page, Product Detail Page, Admin Dashboard)",
          "purpose": "What this screen does from business perspective",
          "user_can": ["Action 1", "Action 2", ...],
          "navigation": {
            "from": ["Screen A", "Screen B"],
            "to": ["Screen C", "Screen D"]
          }
        }

    Example for e-commerce book website:
    1. Solution Manager Tool(action='add_screen', component_data='{"name": "Home Page", "purpose": "Landing page for customers to discover books", "user_can": ["Browse book catalog", "Search by title/author", "Filter by category", "Click on book to view details"], "navigation": {"from": ["Direct entry", "Header navigation"], "to": ["Product Detail Page", "Search Results", "Cart Page"]}}')

    2. Solution Manager Tool(action='add_screen', component_data='{"name": "Product Detail Page", "purpose": "Detailed view of a single book with purchase option", "user_can": ["View book information (title, author, price, description)", "See customer reviews", "Add book to cart", "View related books"], "navigation": {"from": ["Home Page", "Search Results"], "to": ["Cart Page", "Home Page"]}}')

    IMPORTANT: DO NOT include technical details like:
    - Component frameworks (React, Vue, etc.)
    - State management (Redux, Context API)
    - UI libraries or CSS frameworks
    Focus on USER PERSPECTIVE: What can users DO on this screen?

    STEP 3 - DESIGN BACKEND SERVICES (MANDATORY):
    For EACH backend business service needed, you MUST call the Solution Manager Tool:
    Tool: Solution Manager Tool
    Parameters:
      - action: 'add_service'
      - component_data: JSON string with structure:
        {
          "name": "Service Name (e.g., Product Management Service, Order Processing Service)",
          "purpose": "What this service does from business perspective",
          "responsibilities": ["Responsibility 1", "Responsibility 2", ...],
          "supports_screens": ["Screen 1", "Screen 2", ...]
        }

    Example:
    Solution Manager Tool(action='add_service', component_data='{"name": "Product Management Service", "purpose": "Manages book catalog and inventory for the platform", "responsibilities": ["Maintain product information (books)", "Track inventory levels", "Handle product search and filtering", "Provide product recommendations"], "supports_screens": ["Home Page", "Product Detail Page", "Search Results", "Admin Dashboard"]}')

    IMPORTANT: DO NOT include technical details like:
    - API endpoints (GET /api/products, POST /orders)
    - Database schemas (Product table, foreign keys)
    - Technology choices (REST, GraphQL, SQL, NoSQL)
    Focus on BUSINESS RESPONSIBILITIES: What business functions does this service handle?

    STEP 4 - DESIGN BUSINESS FLOWS (MANDATORY):
    For EACH major user journey/workflow, you MUST call the Solution Manager Tool:
    Tool: Solution Manager Tool
    Parameters:
      - action: 'add_flow'
      - component_data: JSON string with structure:
        {
          "name": "Flow Name (e.g., Purchase Flow, User Registration Flow)",
          "description": "What this flow accomplishes",
          "steps": ["Step 1", "Step 2", ...],
          "actors": ["Actor 1", "Actor 2", ...]
        }

    Example:
    Solution Manager Tool(action='add_flow', component_data='{"name": "Book Purchase Flow", "description": "Complete customer journey from browsing to order confirmation", "steps": ["Customer lands on Home Page", "Customer searches or browses books", "Customer clicks on a book to view Product Detail Page", "Customer adds book to cart", "Customer proceeds to Cart Page", "Customer reviews cart items", "Customer proceeds to Checkout Page", "Customer enters shipping information", "Customer selects payment method", "Customer confirms order", "System processes payment", "System creates order record", "System sends confirmation email", "Customer sees Order Confirmation Page"], "actors": ["Customer", "System", "Payment Gateway", "Email Service"]}')

    IMPORTANT: You MUST create solution components for ALL aspects of the requirements.
    Think comprehensively about what screens, services, and flows are needed.

    Minimum requirements:
    - At least 3-5 screens/pages
    - At least 2-3 backend services
    - At least 2-3 business flows

    STEP 5 - FINALIZE:
    After creating all necessary components, provide a final summary response (do NOT make more tool calls).
  expected_output: >
    A summary message confirming solution design completion in this EXACT format:

    "Solution design completed.

    Created components:
    - X screens/pages
    - Y backend services
    - Z business flows

    Total: [X+Y+Z] solution elements"

    CRITICAL: After providing this summary, your task is COMPLETE. Do NOT make additional tool calls.
  agent: solution_designer

solution_validation_task:
  description: >
    Validate the designed solution for completeness and coherence.

    STEP 1 - GET SOLUTION:
    Use the Solution Manager Tool to get current solution:
    Tool: Solution Manager Tool
    Parameters:
      - action: 'get_solution'

    STEP 2 - CHECK COMPLETENESS:
    Use the Solution Manager Tool to check if solution is complete:
    Tool: Solution Manager Tool
    Parameters:
      - action: 'check_complete'

    Requirements to validate against:
    {requirements_summary}

    Current solution components:
    {solution_summary}

    STEP 3 - ANALYZE:
    - Does every requirement have corresponding solution components?
    - Are all user-facing features covered by screens/pages?
    - Are all business logic needs covered by backend services?
    - Are major user journeys documented as business flows?
    - Are there any gaps or missing pieces?

    STEP 4 - PROVIDE VALIDATION REPORT:
    Based on your analysis, provide the final validation report (do NOT make more tool calls after this).

    If gaps found: Clearly identify what's missing and recommend additions.
    If complete: Confirm solution is ready for documentation phase.
  expected_output: >
    A validation report in this EXACT format:

    VALIDATION STATUS: [COMPLETE or INCOMPLETE]

    COVERAGE ANALYSIS:
    - Screens: [Assessment of screens/pages coverage - do they cover all user-facing features?]
    - Services: [Assessment of backend services coverage - do they support all business logic?]
    - Flows: [Assessment of business flows coverage - are all user journeys documented?]

    GAPS IDENTIFIED: [List any missing components or flows, or "None" if complete]

    RECOMMENDATION: [What should happen next]

    CRITICAL: After providing this report, your task is COMPLETE. Do NOT make additional tool calls.
  agent: solution_validator

solution_phase_evaluation_task:
  description: >
    Evaluate if the Solution phase is complete and ready to move to Documentation phase.

    Use the Solution Manager Tool to:
    1. Get solution summary: action='get_summary'
    2. Check completeness: action='check_complete'

    Current solution status:
    {solution_summary}

    Validation results:
    {validation_results}

    Decision criteria:
    - At least 3 screens/pages defined
    - At least 2 backend services defined
    - At least 2 business flows documented
    - OR at least 7 total solution elements
    - All major requirements have corresponding solution components

    If ready: Recommend moving to Documentation phase.
    If not ready: Identify what still needs to be designed.
  expected_output: >
    A clear decision in this format:

    DECISION: [READY or NOT_READY]

    REASONING: [2-3 sentences explaining why]

    NEXT_STEPS: [What should happen next - either move to Documentation phase or what needs to be added to solution]
  agent: phase_coordinator

product_brief_creation_task:
  description: >
    Create a comprehensive Product Brief based on requirements and solution design.

    Requirements:
    {requirements_summary}

    Solution Design:
    {solution_summary}

    Revision Feedback (if any):
    {revision_feedback}

    CRITICAL: You MUST follow these steps IN ORDER:

    STEP 1 - ANALYZE INPUTS:
    Review requirements and solution to understand the product completely.
    Extract key information needed for each Product Brief section.

    STEP 2 - CREATE PRODUCT BRIEF (MANDATORY):
    You MUST call the Documentation Manager Tool to save the Product Brief:
    Tool: Documentation Manager Tool
    Parameters:
      - action: 'save_brief'
      - data: JSON string with structure:
        {
          "product_summary": "Brief overview of the product (2-3 sentences)",
          "problem_statement": "What problem does this solve? Why is it needed?",
          "target_users": "Who will use this product? What are their needs?",
          "product_goals": "What are the key objectives and success criteria?",
          "scope": "What's included and what's NOT included in this product?",
          "revision_count": 0
        }

    IMPORTANT: ALL fields are REQUIRED and must be filled with meaningful content based on requirements.
    Do NOT leave any field empty or with placeholder text.

    If revision_feedback is provided, focus on addressing the specific feedback while keeping other sections intact.

    STEP 3 - VALIDATE COMPLETENESS (MANDATORY):
    After saving, you MUST validate the Product Brief:
    Tool: Documentation Manager Tool
    Parameters:
      - action: 'validate_brief'

    This will check if any required fields are missing.

    STEP 4 - CONFIRM COMPLETION:
    After validation, provide a final confirmation message (do NOT make more tool calls).
  expected_output: >
    A confirmation message in this EXACT format:

    "Product Brief created successfully.

    Sections completed:
    - Product Summary
    - Problem Statement
    - Target Users
    - Product Goals
    - Scope

    Validation: [Result from validate_brief tool]

    The brief is ready for review."

    CRITICAL: After providing this confirmation, your task is COMPLETE. Do NOT make additional tool calls.
  agent: product_brief_writer

product_brief_review_task:
  description: >
    Review the Product Brief for quality, clarity, and alignment with requirements and solution.

    STEP 1 - GET BRIEF:
    Use the Documentation Manager Tool to get the current brief:
    Tool: Documentation Manager Tool
    Parameters:
      - action: 'get_brief'

    Requirements:
    {requirements_summary}

    Solution Design:
    {solution_summary}

    STEP 2 - EVALUATE:
    - Is the Product Summary clear and concise?
    - Does the Problem Statement accurately reflect the requirements?
    - Are Target Users well-defined based on stakeholder requirements?
    - Are Product Goals specific and measurable?
    - Is the Scope clear about what's included and excluded?
    - Does everything align with the requirements and solution?

    STEP 3 - PROVIDE REVIEW:
    Based on your evaluation, provide the final review report (do NOT make more tool calls after this).
    Provide specific, actionable feedback for improvements.
  expected_output: >
    A review report in this EXACT format:

    REVIEW STATUS: [APPROVED or NEEDS_REVISION]

    STRENGTHS: [What's good about the brief]

    IMPROVEMENT AREAS: [Specific sections that need work, if any]

    RECOMMENDATIONS: [Concrete suggestions for improvement]

    CRITICAL: After providing this review, your task is COMPLETE. Do NOT make additional tool calls.
  agent: brief_reviewer

epic_story_creation_task:
  description: >
    Create Epics and User Stories based on the solution design, organized by feature domain.

    Solution Design:
    {solution_summary}

    Revision Feedback (if any):
    {revision_feedback}

    CRITICAL: You MUST follow these steps IN ORDER:

    STEP 1 - IDENTIFY FEATURE DOMAINS:
    Based on solution components, identify 3-5 major feature domains (e.g., Product Management, Cart, Order, Payment, User Management).

    STEP 2 - CREATE EPICS (MANDATORY):
    For EACH feature domain, you MUST call the Documentation Manager Tool:
    Tool: Documentation Manager Tool
    Parameters:
      - action: 'add_epic'
      - data: JSON string with structure:
        {
          "id": "epic-1",
          "name": "Epic Name",
          "description": "What this epic delivers",
          "domain": "Feature Domain (Product/Cart/Order/Payment/etc)"
        }

    STEP 3 - CREATE USER STORIES (MANDATORY):
    For EACH frontend component, backend API, and business flow, create 2-3 User Stories:
    Tool: Documentation Manager Tool
    Parameters:
      - action: 'add_story'
      - data: JSON string with structure:
        {
          "epic_id": "epic-1",
          "title": "As a [role], I want [feature] so that [benefit]",
          "description": "Detailed description of the story",
          "acceptance_criteria": [
            "Given [context], when [action], then [outcome]",
            "Another acceptance criterion"
          ]
        }

    Target: Create at least 10-15 user stories total covering all solution components.

    If revision_feedback is provided, focus on addressing specific gaps or changes requested.

    STEP 4 - FINALIZE:
    After creating all epics and stories, provide a final summary response (do NOT make more tool calls).

    IMPORTANT: Create comprehensive stories covering ALL solution components.
  expected_output: >
    A summary message in this EXACT format:

    "Backlog creation completed.

    Created:
    - X epics organized by feature domain
    - Y user stories with acceptance criteria

    Feature domains covered: [list domain names]"

    CRITICAL: After providing this summary, your task is COMPLETE. Do NOT make additional tool calls.
  agent: epic_story_writer

backlog_validation_task:
  description: >
    Validate that Epics and Stories comprehensively cover the solution design.

    STEP 1 - GET DOCUMENTATION:
    Use the Documentation Manager Tool to get current documentation:
    Tool: Documentation Manager Tool
    Parameters:
      - action: 'get_documentation'

    Solution Design:
    {solution_summary}

    STEP 2 - ANALYZE:
    - Does every frontend component have corresponding user stories?
    - Does every backend API have corresponding user stories?
    - Does every business flow have corresponding user stories?
    - Are epics properly organized by feature domain?
    - Do all stories have clear acceptance criteria?
    - Are there any gaps or missing stories?

    STEP 3 - PROVIDE VALIDATION:
    Based on your analysis, provide the final validation report (do NOT make more tool calls after this).
  expected_output: >
    A validation report in this EXACT format:

    VALIDATION STATUS: [COMPLETE or INCOMPLETE]

    COVERAGE ANALYSIS:
    - Epics: [Assessment of epic organization]
    - Stories: [Assessment of story coverage]
    - Acceptance Criteria: [Assessment of criteria quality]

    GAPS IDENTIFIED: [List any missing stories or epics, or "None" if complete]

    RECOMMENDATIONS: [What should be added or improved]

    CRITICAL: After providing this validation, your task is COMPLETE. Do NOT make additional tool calls.
  agent: backlog_validator
